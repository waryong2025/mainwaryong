<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚™ì‚°ìš´ìˆ˜ 3-1ë²ˆ ê·¼ë¬´í˜„í™©í‘œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background-color: #f4f4f4; color: #333;
            font-size: 14pt;
        }
        .controls {
            background-color: #fff;
            padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 15px;
            display: flex; flex-wrap: wrap; gap: 10px;
            align-items: center;
        }
        .controls label { font-weight: bold; margin-right: 5px;
        }
        .controls input[type="number"], .controls select {
            padding: 6px;
            border: 1px solid #ddd; border-radius: 4px;
            width: 70px; box-sizing: border-box;
        }

        /* âœ… ì¸ì‡„ ì˜µì…˜ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë„ˆë¹„ ì¡°ì • */
        .controls select.margin-select {
            width: 55px; /* ì‘ì€ í¬ê¸°ë¡œ ì¡°ì • */
            padding: 1px 3px; /* ì‘ì€ í¬ê¸°ë¡œ ì¡°ì • */
            font-size: 0.9em;
        }
        /* âœ… ìƒˆë¡œìš´ ê·¼ë¬´í‘œ ê´€ë¦¬ ì˜µì…˜ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (ìš”ì²­í•˜ì‹  ëˆˆì— ë„ëŠ” ìƒ‰ìƒ ì ìš© - ë°ì€ë…¹ìƒ‰) */
        .controls select.action-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #28a745; /* ë°ì€ë…¹ìƒ‰ */
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
        }
        /* âœ… ê´€ë ¨ ì„œë¹„ìŠ¤ ì´ë™ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .controls select.service-select {
            padding: 8px 15px; 
            font-size: 17.5px;
            background-color: #17a2b8; /* ê¸°ì¡´ ë§í¬ ë²„íŠ¼ ìƒ‰ìƒ */
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
        }
        
        .controls input[type="radio"] { margin-left: 10px; }
        .controls button, .controls a.button-link {
            padding: 8px 15px;
            color: white; border: none; border-radius: 4px;
            cursor: pointer; font-size: 17.5px; margin-right: 8px;
            text-decoration: none; display: inline-block; text-align: center; white-space: nowrap;
        }
        .controls button { background-color: #007bff;
        }
        .controls button:hover { background-color: #0056b3;
        }
        .controls a.button-link { background-color: #17a2b8;
        }
        .controls a.button-link:hover { background-color: #138496;
        }
        .controls button.btn-danger { background-color: #dc3545; }
        .controls button.btn-danger:hover { background-color: #c82333; }

        #scheduleContainer {
            background-color: white;
            padding: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px auto; max-width: 95%; overflow-x: auto;
        }
        table {
            width: 100%;
            min-width: 1200px; border-collapse: collapse;
            margin: 0 auto; font-size: 0.9em; background-color: #fff; table-layout: fixed;
        }
        caption {
            font-size: 1.5em;
            margin-bottom: 10px; font-weight: bold;
            color: #333; text-decoration: underline;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px; text-align: center;
            vertical-align: top; line-height: 1.1; word-break: keep-all;
            height: 38px; box-sizing: border-box;
            font-size: 13pt;
        }
        th { background-color: #f2f2f2; font-weight: bold;
        }
        .sunday { background-color: #ffe0e0;
        }
        .saturday { background-color: #e0e0ff;
        }
        .holiday { background-color: #ffcccc; font-weight: bold; color: #cc0000;
        }
        .edit-mode {
            position: relative;
            padding: 2px; display: flex; flex-direction: column;
            justify-content: center; height: 100%;
        }
        .edit-mode input {
            width: calc(100% - 8px);
            margin-bottom: 2px;
            padding: 2px; box-sizing: border-box;
        }
        .edit-mode .cell-buttons { display: flex;
            justify-content: space-around; margin-top: 2px; }
        .edit-mode .cell-buttons button {
            padding: 3px 5px;
            font-size: 0.7em; color: white; border: none;
            border-radius: 3px; cursor: pointer; white-space: nowrap;
        }
        .edit-mode .cell-buttons button.btn-fixed { background-color: #28a745;
        }
        .edit-mode .cell-buttons button.btn-temp { background-color: #ffc107;
        }
        .edit-mode .cell-buttons button.btn-highlight-am { background-color: #ff8c00;
        }
        .edit-mode .cell-buttons button.btn-highlight-pm { background-color: #ff8c00;
        }
        .edit-mode button:disabled { cursor: not-allowed; opacity: 0.6;
        }
        .edit-mode .cell-buttons button.btn-delete { background-color: #dc3545;
        }

        .name-entry { display: block; margin-top: 2px; margin-bottom: 2px;
        }
        .name-entry.bold-name { font-weight: bold;
        }
        .hidden-x {
            color: white;
        }
        table th:nth-child(1),
        table td:nth-child(1),
        table th:nth-child(2),
        table td:nth-child(2) {
            width: 4%;
            min-width: 60px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px; border-radius: 10px;
            max-width: 90%; max-height: 90%; overflow-y: auto;
            position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .modal-content h3 { margin-top: 0;
        }
        .close-button {
            position: absolute;
            right: 10px; top: 5px;
            font-size: 25px; font-weight: bold;
            color: #aaa; cursor: pointer;
        }
        .count-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .count-table th, .count-table td {
            border: 1px solid #ddd;
            padding: 8px; text-align: center;
        }
        .count-table th { background-color: #f2f2f2;
        }
        
        @media print {
            @page {
                size: A4;
                /* âœ… CSS ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—¬ë°± ì„¤ì • */
                margin: 10mm;
                margin-left: var(--print-margin-left, 10mm);
                margin-right: var(--print-margin-right, 10mm);
            }
            body {
                background-color: white;
                margin: 0; padding: 0;
                -webkit-print-color-adjust: exact;
            }
            .controls { display: none;
            }
            #scheduleContainer { box-shadow: none; margin: 0; padding: 0;
            }
            table {
                width: 100%;
                min-width: unset;
                font-size: 0.8em;
                border: 1px solid #000;
                table-layout: fixed;
            }
            th, td { padding: 1px; height: auto;
                word-break: break-all; }

            table th:nth-child(1),
            table td:nth-child(1),
            table th:nth-child(2),
            table td:nth-child(2) {
                width: 4%;
            }
            .modal-content {
                position: static;
                width: 100%;
                max-width: none;
                max-height: none;
                box-shadow: none;
                overflow-y: visible;
            }
            .modal {
                display: flex;
                position: static;
                background-color: transparent;
            }
            .modal .close-button { display: none;
            }
        }
        @media screen and (max-width: 768px) {
            .controls { flex-direction: column;
                align-items: stretch; }
            .controls input[type="number"], .controls select, .controls button, .controls a.button-link { width: 100%;
                box-sizing: border-box; margin: 5px 0; }
            .controls select.service-select, .controls select.action-select { width: 100%; }
            #scheduleContainer { padding: 5px;
            }
            table { font-size: 0.8em;
            }
            th, td { padding: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="yearInput">ë…„ë„:</label>
        <input type="number" id="yearInput" value="2025">
        <label for="monthInput">ì›”:</label>
        <input type="number" id="monthInput" value="9">
        
        <input type="radio" id="option1" name="displayOption" value="1">
        <label for="option1">1ì¼ ~ 15ì¼</label>
        <input type="radio" id="option2" name="displayOption" value="2" checked>
        <label for="option2">16ì¼ ~ ë§ì¼</label>
        
        <button onclick="generateSchedule()">ìƒì„±</button>
        <button onclick="calculateWorkdays()">3-1ë²ˆ ê·¼ë¬´ì¼ìˆ˜ê³„ì‚°</button>

        <div style="display: flex; align-items: center; gap: 5px; margin-left: 10px;">
            <button onclick="printPage()">ì¸ì‡„ì‹¤í–‰</button>
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <div style="display: flex; align-items: center; gap: 3px; font-size: 0.9em; height: 18px;">
                    <label for="marginLeftSelect">ì¢Œì¸¡ì—¬ë°±:</label>
                    <select id="marginLeftSelect" class="margin-select">
                        <option value="0">0</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 3px; font-size: 0.9em; height: 18px;">
                    <label for="marginRightSelect">ìš°ì¸¡ì—¬ë°±:</label>
                    <select id="marginRightSelect" class="margin-select">
                        <option value="0">0</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                    </select>
                </div>
            </div>
        </div>
        
        <select id="scheduleActionsSelect" class="action-select" onchange="handleScheduleActions()">
            <option value="">ê·¼ë¬´í‘œ ê´€ë¦¬ ì˜µì…˜</option>
            <option value="reset">ì „ì²´ ê³ ì • ì´ˆê¸°í™”</option>
            <option value="backup">ê·¼ë¬´ì ë°±ì—… ë‹¤ìš´</option>
            <option value="restore">ê·¼ë¬´ì ë³µêµ¬ ì—…ë¡œë“œ</option>
        </select>
        <input type="file" id="restoreFile" style="display: none;" onchange="restoreScheduleData(this.files[0])" accept=".json">

        <select id="serviceSelect" class="service-select" onchange="navigateService()">
            <option value="">ê´€ë ¨ ì„œë¹„ìŠ¤ ì´ë™</option>
            <option value="https://waryong2025.github.io/townbus/">08ë²ˆ ë°°ì°¨í‘œ</option>
            <option value="https://waryong2025.github.io/timeman/">07ë²ˆ ë°°ì°¨í‘œ</option>
            <option value="https://waryong2025.github.io/main/">08ë²ˆ ê·¼ë¬´í˜„í™©í‘œ</option>
            <option value="https://waryong2025.github.io/time">07ë²ˆ ê·¼ë¬´í˜„í™©í‘œ</option>
            <option value="https://waryong2025.github.io/mainwaryong">3-1ë²ˆ ê·¼ë¬´í˜„í™©í‘œ</option>
            <option value="https://waryong2025.github.io/testtime">3-2ë²ˆ ê·¼ë¬´í˜„í™©í‘œ</option>
        </select>
    </div>
    <div id="scheduleContainer">
        <table>
            <caption id="tableCaption">ë‚™ì‚°ìš´ìˆ˜ 3-1ë²ˆ 2025ë…„ 9ì›” 16ì¼ ~ 30ì¼ê¹Œì§€ ê·¼ë¬´í˜„í™©í‘œ</caption>
            <thead id="scheduleHeader">
            </thead>
            <tbody id="scheduleBody">
            </tbody>
        </table>
    </div>

    <div id="workdayModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalTableContainer"></div>
        </div>
    </div>

    <script>
        // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: ë¡œí…Œì´ì…˜ ì°¨ëŸ‰ 4ëŒ€ (3614, 3270, 5943, 5942) ì‚­ì œ
        const VEHICLE_COLUMNS = ['3214', '3215', '3326', '3327', '5941', '5903', 'ë¹„ê³ '];
        // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: ë¡œí…Œì´ì…˜ ê´€ë ¨ ìƒìˆ˜ ì‚­ì œ
        // const ROTATION_VEHICLES = { '3614': '5941', '5941': '3270', '3270': '5943', '5943': '5942', '5942': '3614' };
        
        const STORAGE_KEY_FIXED = 'naksanjongro3-1FixedSchedule';
        const STORAGE_KEY_TEMP = 'naksanjongro3-1TempSchedule';

        let fixedScheduleData = JSON.parse(localStorage.getItem(STORAGE_KEY_FIXED)) || {};
        let tempScheduleData = JSON.parse(localStorage.getItem(STORAGE_KEY_TEMP)) || {};
        let scheduleData = {};
        
        function getDayName(dayOfWeek) {
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return days[dayOfWeek];
        }

        function isPublicHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const holidays = [
                // { month: 1, day: 1, name: 'ì‹ ì •' },
                // { month: 3, day: 1, name: 'ì‚¼ì¼ì ˆ' },
            ];
            return holidays.some(h => h.month === month && h.day === day);
        }

        function renderCellContent(names) {
            if (!names || names.length === 0) return '';
            return names.map(item => {
                const text = item.text.trim();
                const display = text === '' ? '.' : text;
                const hiddenClass = text === '' ? ' hidden-x' : '';
                return `<span class="name-entry${hiddenClass} ${item.bold ? 'bold-name' : ''}">${display}</span>`;
            }).join('');
        }
        
        function editCell(cell, colId, dateString, dayOfWeek) {
            if (cell.classList.contains('edit-mode')) return;
            document.querySelectorAll('.edit-mode').forEach(editCell => {
                const prevColId = editCell.dataset.colId;
                const prevDateString = editCell.dataset.dateString;
                const originalNames = (scheduleData[prevDateString] && scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                editCell.classList.remove('edit-mode');
                editCell.innerHTML = renderCellContent(originalNames);
            });
            const currentNames = (scheduleData[dateString] && scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
            const morningValue = currentNames[0] ? currentNames[0].text : '';
            const afternoonValue = currentNames[1] ? currentNames[1].text : '';

            // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: 3614ë²ˆ ì°¨ëŸ‰ ë¡œì§ ì œê±°ë¡œ ì¸í•´ ì¼ìš”ì¼ íœ´ë¬´ ë¡œì§ ì œê±°
            const isSundayFixed = false; // ì´ì œ ì¼ë°˜ì ì¸ ê³ ì • ì €ì¥ ê°€ëŠ¥

            cell.classList.add('edit-mode');
            cell.dataset.colId = colId;
            cell.dataset.dateString = dateString;
            cell.dataset.dayOfWeek = dayOfWeek;
            cell.innerHTML = `
                <input type="text" class="morning-input" value="${morningValue}" placeholder="ì˜¤ì „" data-bold="${currentNames[0].bold}">
                <input type="text" class="afternoon-input" value="${afternoonValue}" placeholder="ì˜¤í›„" data-bold="${currentNames[1].bold}">
                <div class="cell-buttons">
                    <button class="btn-fixed" onclick="saveFixedCell(this.parentNode.parentNode)" ${isSundayFixed ? 'disabled title="ì¼ìš”ì¼ì€ ê³ ì • ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."' : ''}>ê³ ì •</button>
                    <button class="btn-temp" onclick="saveTempCell(this.parentNode.parentNode)">ì„ì‹œ</button>
                    <button class="btn-highlight-am" onclick="highlightCell(this.parentNode.parentNode, 'am')">ì˜¤ì „ ê°•ì¡°</button>
                    <button class="btn-highlight-pm" onclick="highlightCell(this.parentNode.parentNode, 'pm')">ì˜¤í›„ ê°•ì¡°</button>
                    <button class="btn-delete" onclick="deleteCell(this.parentNode.parentNode)">ì‚­ì œ</button>
                </div>
            `;
            cell.querySelector('.morning-input').focus();
        }
        
        function getNamesAndBoldStateFromCell(cellElement) {
            const morningInput = cellElement.querySelector('.morning-input');
            const afternoonInput = cellElement.querySelector('.afternoon-input');
            const morningText = morningInput.value.trim();
            const afternoonText = afternoonInput.value.trim();

            const morningBold = morningInput.dataset.bold === 'true';
            const afternoonBold = afternoonInput.dataset.bold === 'true';
            
            return [
                { text: morningText, bold: morningBold },
                { text: afternoonText, bold: afternoonBold }
            ];
        }

        function highlightCell(cellElement, timeOfDay) {
            let inputElement;
            if (timeOfDay === 'am') {
                inputElement = cellElement.querySelector('.morning-input');
            } else if (timeOfDay === 'pm') {
                inputElement = cellElement.querySelector('.afternoon-input');
            }
            if (inputElement) {
                const isCurrentlyBold = inputElement.dataset.bold === 'true';
                inputElement.dataset.bold = !isCurrentlyBold;
                inputElement.style.fontWeight = inputElement.dataset.bold === 'true' ? 'bold' : 'normal';
            }
        }

        function saveFixedCell(cellElement) {
            const { colId, dayOfWeek, dateString } = cellElement.dataset;
            const namesToSave = getNamesAndBoldStateFromCell(cellElement);
            
            // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: 3614ë²ˆ ì¼ìš”ì¼ íœ´ë¬´ ë¡œì§ ì œê±°

            // í˜„ì¬ ë‚ ì§œ ê³ ì • ì €ì¥
            const currentRecurringKey = `${dayOfWeek}-${colId}`;
            if (!fixedScheduleData[currentRecurringKey]) {
                fixedScheduleData[currentRecurringKey] = [];
            }
            fixedScheduleData[currentRecurringKey] = fixedScheduleData[currentRecurringKey].filter(
                entry => entry.dateString !== dateString
            );
            fixedScheduleData[currentRecurringKey].push({ dateString: dateString, names: namesToSave });

            // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: 3614ë²ˆ ë¡œí…Œì´ì…˜ ë¡œì§ ì™„ì „íˆ ì œê±°

            // ê°€ì¥ ìµœê·¼ ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
            for (const key in fixedScheduleData) {
                fixedScheduleData[key].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
            }

            localStorage.setItem(STORAGE_KEY_FIXED, JSON.stringify(fixedScheduleData));
            generateSchedule();
        }

        function saveTempCell(cellElement) {
            const { colId, dateString } = cellElement.dataset;
            const namesToSave = getNamesAndBoldStateFromCell(cellElement);
            if (!tempScheduleData[dateString]) {
                tempScheduleData[dateString] = {};
            }
            tempScheduleData[dateString][colId] = namesToSave;
            localStorage.setItem(STORAGE_KEY_TEMP, JSON.stringify(tempScheduleData));
            generateSchedule();
        }

        function deleteCell(cellElement) {
            const { colId, dayOfWeek, dateString } = cellElement.dataset;
            const recurringKey = `${dayOfWeek}-${colId}`;

            // ì„ì‹œ ëª…ë‹¨ ì‚­ì œ
            if (tempScheduleData[dateString] && tempScheduleData[dateString][colId]) {
                delete tempScheduleData[dateString][colId];
                if (Object.keys(tempScheduleData[dateString]).length === 0) {
                    delete tempScheduleData[dateString];
                }
                localStorage.setItem(STORAGE_KEY_TEMP, JSON.stringify(tempScheduleData));
            }

            // ê³ ì • ëª…ë‹¨ ì²˜ë¦¬: ì‚­ì œ ì‹œì  ì´í›„ì˜ ìë™ ìƒì„± ëª…ë‹¨ì„ ì§€ìš°ê¸° ìœ„í•´,
            // í•´ë‹¹ ë‚ ì§œì— ë¹ˆ ëª…ë‹¨ìœ¼ë¡œ ê³ ì • ìŠ¤ì¼€ì¤„ì„ ì €ì¥í•©ë‹ˆë‹¤.
            const emptyNames = [{ text: '', bold: false }, { text: '', bold: false }];

            if (!fixedScheduleData[recurringKey]) {
                fixedScheduleData[recurringKey] = [];
            }
            // ê¸°ì¡´ì˜ í•´ë‹¹ ë‚ ì§œ ì—”íŠ¸ë¦¬ë¥¼ ì œê±° (ìˆë‹¤ë©´)
            fixedScheduleData[recurringKey] = fixedScheduleData[recurringKey].filter(
                entry => entry.dateString !== dateString
            );
            // ë¹ˆ ëª…ë‹¨ìœ¼ë¡œ ìƒˆ ì—”íŠ¸ë¦¬ ì¶”ê°€
            fixedScheduleData[recurringKey].push({ dateString: dateString, names: emptyNames });

            // ê°€ì¥ ìµœê·¼ ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
            fixedScheduleData[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));

            localStorage.setItem(STORAGE_KEY_FIXED, JSON.stringify(fixedScheduleData));

            generateSchedule();
        }
        
        function resetAllFixedSchedules() {
            if (prompt("ì €ì¥ëœ ëª¨ë“  ê³ ì • ê·¼ë¬´í‘œë¥¼ ì‚­ì œí•˜ì‹œë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.") === "3113") {
                if (confirm("ëª¨ë“  ê³ ì • ê·¼ë¬´í‘œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    fixedScheduleData = {};
                    localStorage.removeItem(STORAGE_KEY_FIXED);
                    if (confirm("ì„ì‹œ ê·¼ë¬´í‘œë„ í•¨ê»˜ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        tempScheduleData = {};
                        localStorage.removeItem(STORAGE_KEY_TEMP);
                    }
                    generateSchedule();
                    alert("ëª¨ë“  ê·¼ë¬´í‘œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ ì‹ ì²­í•˜ì„¸ìš”.");
            }
        }

        function getScheduleForDay(currentDate) {
            const dateString = currentDate.toISOString().slice(0, 10);
            const dayOfWeek = currentDate.getDay(); // 0 (ì¼) ~ 6 (í† )
            const dailySchedule = {};
            // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: ë¡œí…Œì´ì…˜ ê´€ë ¨ ì°¨ëŸ‰ ìˆœì„œ ë³€ìˆ˜ ì‚­ì œ

            VEHICLE_COLUMNS.forEach(colId => {
                let names = null;

                // 1. ì„ì‹œ ì €ì¥ëœ ë°ì´í„° í™•ì¸ (ìµœìš°ì„ )
                if (tempScheduleData[dateString] && tempScheduleData[dateString][colId]) {
                    names = tempScheduleData[dateString][colId];
                } 
                // 2. ê³µíœ´ì¼ íœ´ë¬´ ì²˜ë¦¬
                // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: 3614ë²ˆ ì¼ìš”ì¼ íœ´ë¬´ ë¡œì§ ì œê±°
                else if (isPublicHoliday(currentDate)) {
                    names = [{ text: '', bold: false }, { text: '', bold: false }];
                }
                // 3. ê³ ì • ìŠ¤ì¼€ì¤„ ë°ì´í„° í™•ì¸
                else {
                    const recurringKey = `${dayOfWeek}-${colId}`;
                    const rules = fixedScheduleData[recurringKey];
                    if (rules && rules.length > 0) {
                        const mostRecentRule = rules.find(rule => new Date(rule.dateString) <= currentDate);

                        if (mostRecentRule) {
                            names = mostRecentRule.names;
                            // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: 3614ë²ˆ ë¡œí…Œì´ì…˜ ë¡œì§ ì™„ì „íˆ ì œê±°
                        }
                    }
                }

                dailySchedule[colId] = names || [{ text: '', bold: false }, { text: '', bold: false }];
            });
            return dailySchedule;
        }

        function generateSchedule() {
            const year = parseInt(document.getElementById('yearInput').value);
            const month = parseInt(document.getElementById('monthInput').value);
            const selectedOption = document.querySelector('input[name="displayOption"]:checked').value;
            
            const scheduleHeader = document.getElementById('scheduleHeader');
            const scheduleBody = document.getElementById('scheduleBody');
            const tableCaption = document.getElementById('tableCaption');
            
            scheduleHeader.innerHTML = `<tr><th>ì›”ì¼</th><th>ìš”ì¼</th>${VEHICLE_COLUMNS.map(c => `<th>${c}</th>`).join('')}</tr>`;
            scheduleBody.innerHTML = '';
            
            const startDateNum = selectedOption === '1' ? 1 : 16;
            const startDate = new Date(year, month - 1, startDateNum);
            const endDate = (selectedOption === '1') ? new Date(year, month - 1, 15) : new Date(year, month, 0);
            
            tableCaption.textContent = `ë‚™ì‚°ìš´ìˆ˜ 3-1ë²ˆ ${year}ë…„ ${month}ì›” ${startDate.getDate()}ì¼ ~ ${endDate.getDate()}ì¼ê¹Œì§€ ê·¼ë¬´í˜„í™©í‘œ`;
            
            scheduleData = {};

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const currentDate = new Date(d);
                const dateString = currentDate.toISOString().slice(0, 10);
                const dayOfWeek = currentDate.getDay();
                
                const cellsContent = getScheduleForDay(currentDate);
                scheduleData[dateString] = cellsContent;
                
                let rowClass = '';
                if (isPublicHoliday(currentDate)) {
                    rowClass = 'holiday';
                } else if (dayOfWeek === 0) {
                    rowClass = 'sunday';
                } else if (dayOfWeek === 6) {
                    rowClass = 'saturday';
                }

                const dataCellsHTML = VEHICLE_COLUMNS.map(colId =>
                    `<td onclick="editCell(this, '${colId}', '${dateString}', ${dayOfWeek})">${renderCellContent(cellsContent[colId])}</td>`
                ).join('');

                scheduleBody.insertAdjacentHTML('beforeend', `
                    <tr class="${rowClass}">
                        <td>${currentDate.getDate()}</td>
                        <td>${getDayName(dayOfWeek)}</td>
                        ${dataCellsHTML}
                    </tr>`);
            }
        }

        function calculateWorkdays() {
            const year = parseInt(document.getElementById('yearInput').value);
            const month = parseInt(document.getElementById('monthInput').value);
            
            const workdayCounts = {};
            const shiftCounts = {};
            
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dailySchedule = getScheduleForDay(new Date(d));
                const dayWorkdays = new Set();

                for (const colId in dailySchedule) {
                    if (colId !== 'ë¹„ê³ ') {
                        dailySchedule[colId].forEach((item, index) => {
                            const name = item.text.trim();
                            if (name) {
                                shiftCounts[name] = shiftCounts[name] || { ì˜¤ì „: 0, ì˜¤í›„: 0 };
                                if (index === 0) shiftCounts[name].ì˜¤ì „++;
                                else shiftCounts[name].ì˜¤í›„++;
                                dayWorkdays.add(name);
                            }
                        });
                    }
                }
                dayWorkdays.forEach(name => {
                    workdayCounts[name] = (workdayCounts[name] || 0) + 1;
                });
            }
            
            const combinedData = Object.keys(workdayCounts).map(name => ({
                name: name,
                workdays: workdayCounts[name],
                morningShifts: shiftCounts[name]?.ì˜¤ì „ || 0,
                afternoonShifts: shiftCounts[name]?.ì˜¤í›„ || 0
            })).sort((a, b) => b.workdays - a.workdays);

            const title = `${year}ë…„ ${month}ì›” ê·¼ë¬´ì¼ìˆ˜`;
            const tableHTML = `
                <table class="count-table">
                    <thead><tr><th>ì´ë¦„</th><th>ì˜¤ì „</th><th>ì˜¤í›„</th><th>ì´ ê·¼ë¬´ì¼ìˆ˜</th></tr></thead>
                    <tbody>${combinedData.map(data => `<tr><td>${data.name}</td><td>${data.morningShifts}ì¼</td><td>${data.afternoonShifts}ì¼</td><td>${data.workdays}ì¼</td></tr>`).join('')}</tbody>
                </table>`;

            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalTableContainer').innerHTML = tableHTML;
            document.getElementById('workdayModal').style.display = 'flex';
        }

        // âœ… ì¸ì‡„ ì˜µì…˜ ì ìš© í•¨ìˆ˜
        function printPage() {
            const editCell = document.querySelector('.edit-mode');
            if (editCell) {
                const { colId, dateString } = editCell.dataset;
                const originalNames = (scheduleData[dateString] && scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                editCell.classList.remove('edit-mode');
                editCell.innerHTML = renderCellContent(originalNames);
            }

            // âœ… ì—¬ë°± ì˜µì…˜ ê°’ì„ ê°€ì ¸ì™€ CSS ë³€ìˆ˜ë¡œ ì„¤ì •
            const marginLeft = document.getElementById('marginLeftSelect').value;
            const marginRight = document.getElementById('marginRightSelect').value;
            
            document.documentElement.style.setProperty('--print-margin-left', `${marginLeft}mm`);
            document.documentElement.style.setProperty('--print-margin-right', `${marginRight}mm`);

            const originalTitle = document.title;
            const captionText = document.getElementById('tableCaption').textContent;
            
            const matches = captionText.match(/(\d{4})ë…„ (\d{1,2})ì›” (\d{1,2})ì¼ ~ (\d{1,2})ì¼ê¹Œì§€/);

            let newTitle = "ë‚™ì‚°ìš´ìˆ˜ 3-1ë²ˆ ê·¼ë¬´í˜„í™©í‘œ";
            if (matches) {
                const year = matches[1];
                const month = matches[2].padStart(2, '0');
                const startDay = matches[3].padStart(2, '0');
                const endDay = matches[4].padStart(2, '0');
                newTitle = `ë‚™ì‚°3-1 ${year}-${month} (${startDay}ì¼-${endDay}ì¼)`;
            }

            const handleAfterPrint = () => {
                document.title = originalTitle;
                document.documentElement.style.removeProperty('--print-margin-left');
                document.documentElement.style.removeProperty('--print-margin-right');
                window.removeEventListener('afterprint', handleAfterPrint);
            };
            window.addEventListener('afterprint', handleAfterPrint);

            document.title = newTitle;
            window.print();
        }

        function closeModal() {
            document.getElementById('workdayModal').style.display = 'none';
        }
        
        // --- ë°±ì—… ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ ---
        function backupScheduleData() {
            const dataToSave = {
                fixedSchedule: fixedScheduleData,
                tempSchedule: tempScheduleData,
                storageKeys: {
                    fixed: STORAGE_KEY_FIXED,
                    temp: STORAGE_KEY_TEMP
                }
            };

            const dataStr = JSON.stringify(dataToSave); 
            const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' }); 
            
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const fileName = `ë‚™ì‚°3-1_ê·¼ë¬´í‘œ_ë°±ì—…_v3_${year}${month}${day}_${hours}${minutes}.json`;
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName; 
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            alert(`ê·¼ë¬´í‘œ ë°±ì—… ë°ì´í„° íŒŒì¼ (${fileName})ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— JSON íŒŒì¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`);
        }
        // ----------------------------------------------------------------

        // --- ë°±ì—… ë³µêµ¬ (ì—…ë¡œë“œ) í•¨ìˆ˜ ---
        function restoreScheduleData(file) {
            const selectElement = document.getElementById('scheduleActionsSelect');
            if (!file) {
                selectElement.value = '';
                return;
            }
            
            if (!confirm(`[${file.name}] íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì €ì¥ëœ 3-1ë²ˆ ê·¼ë¬´í‘œë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤.)`)) {
                document.getElementById('restoreFile').value = ''; 
                selectElement.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const loadedData = JSON.parse(event.target.result);
                    
                    const fixedKey = STORAGE_KEY_FIXED;
                    const tempKey = STORAGE_KEY_TEMP;

                    let loadedFixed = loadedData.fixedSchedule || loadedData[fixedKey];
                    let loadedTemp = loadedData.tempSchedule || loadedData[tempKey];

                    if (!loadedFixed || !loadedTemp) {
                        alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë°±ì—… íŒŒì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        document.getElementById('restoreFile').value = '';
                        selectElement.value = '';
                        return;
                    }

                    // ë°ì´í„° ë³µêµ¬ (localStorageì— ì €ì¥)
                    fixedScheduleData = loadedFixed;
                    tempScheduleData = loadedTemp;
                    localStorage.setItem(fixedKey, JSON.stringify(fixedScheduleData));
                    localStorage.setItem(tempKey, JSON.stringify(tempScheduleData));
                    
                    // UI ì—…ë°ì´íŠ¸ ë° ì•Œë¦¼
                    generateSchedule();
                    alert(`[${file.name}] íŒŒì¼ë¡œë¶€í„° ê·¼ë¬´í‘œ ë°ì´í„° ë³µêµ¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. í™”ë©´ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                    document.getElementById('restoreFile').value = ''; 
                    selectElement.value = '';

                } catch (e) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    console.error('Restore Error:', e);
                    document.getElementById('restoreFile').value = '';
                    selectElement.value = '';
                }
            };
            reader.onerror = function() {
                alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                document.getElementById('restoreFile').value = '';
                selectElement.value = '';
            };
            
            reader.readAsText(file);
        }
        // ----------------------------------------------------------------

        // âœ… í†µí•©ëœ ê·¼ë¬´í‘œ ê´€ë¦¬ ì˜µì…˜ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì¶”ê°€
        function handleScheduleActions() {
            const selectElement = document.getElementById('scheduleActionsSelect');
            const action = selectElement.value;
            
            if (action === 'reset') {
                resetAllFixedSchedules();
            } else if (action === 'backup') {
                backupScheduleData();
            } else if (action === 'restore') {
                // ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ í•„ë“œë¥¼ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ì°½ì„ ë„ì›ë‹ˆë‹¤.
                document.getElementById('restoreFile').click();
            }
            
            // ì‘ì—…ì„ ìˆ˜í–‰í•œ í›„, ì…€ë ‰íŠ¸ ë°•ìŠ¤ë¥¼ ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ì´ˆê¸°í™”
            if (action !== 'restore') { // restoreëŠ” íŒŒì¼ ì„ íƒ ì™„ë£Œ í›„ ì´ˆê¸°í™”
                selectElement.value = ''; 
            }
        }
        
        // âœ… ê´€ë ¨ ì„œë¹„ìŠ¤ ì´ë™ í•¨ìˆ˜ ì¶”ê°€ (08ë²ˆ íŒŒì¼ ê¸°ë°˜ ëª©ë¡ ì ìš©)
        function navigateService() {
            const selectElement = document.getElementById('serviceSelect');
            const url = selectElement.value;
            if (url) {
                window.open(url, '_blank');
                // ì´ë™ í›„ ì˜µì…˜ì„ ì´ˆê¸°í™”í•˜ì—¬ ì‚¬ìš©ìê°€ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ í•¨
                selectElement.value = ''; 
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('yearInput').value = today.getFullYear();
            document.getElementById('monthInput').value = today.getMonth() + 1;
            const currentDay = today.getDate();
            if (currentDay <= 15) {
                document.getElementById('option1').checked = true;
            } else {
                document.getElementById('option2').checked = true;
            }
            generateSchedule();
        });
    </script>
</body>
</html>



